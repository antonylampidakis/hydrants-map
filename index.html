<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <title>Î§Î¬ÏÏ„Î·Ï‚ ÎšÏÎ¿Ï…Î½ÏÎ½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />

</head>
<body>
<header>
  <h1>Î§Î¬ÏÏ„Î·Ï‚ ÎºÏÎ¿Ï…Î½ÏÎ½</h1>
  <input id="file-xlsx" type="file" accept=".xlsx" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;">
  <label for="file-xlsx" class="btn">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Excel (.xlsx)</label>
  <img src="images.jpg" alt="Î›Î¿Î³ÏŒÏ„Ï…Ï€Î¿" class="logo" />
</header>

<div class="wrap">
  <div id="map" class="card"></div>

  <div class="panel">
    <input id="search" class="search card" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÎµ ÏŒÎ½Î¿Î¼Î±/ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·/ÏƒÏ„Î¿ÏÏ„Ï‚/Î´Î®Î¼Î¿/Ï†Ï‰Î»Î¹Î¬â€¦" />

    <div class="card filters">
  <div class="toolbar">
    <div class="toolbar-left">
      <!-- 1Î· ÏƒÎµÎ¹ÏÎ¬ -->
      <label class="chip row1">
        <input type="checkbox" id="f-only-ok" />
        <span>ÎœÏŒÎ½Î¿ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÎºÎ¿Î¯</span>
      </label>

      <label class="chip row1">
        <input type="checkbox" id="f-only-storts" />
        <span>ÎœÏŒÎ½Î¿ ÏŒÏƒÎ¿Î¹ Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î¿ÏÏ„Ï‚</span>
      </label>

      <!-- Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ â€œÎºÎµÎ½ÏŒâ€ Î³Î¹Î± Î½Î± ÎºÎ¬Ï„ÏƒÎ¿Ï…Î½ Ï‰ÏÎ±Î¯Î± Î¿Î¹ Î´ÏÎ¿ Î´Î¹Î±ÎºÏŒÏ€Ï„ÎµÏ‚ ÏƒÏ„Î· 1Î· ÏƒÎµÎ¹ÏÎ¬ -->
      <div class="row1"></div>

      <!-- 2Î· ÏƒÎµÎ¹ÏÎ¬ -->
      <select id="f-cabinet" class="select-pill row2">
        <option value="">Î Ï…ÏÎ¿ÏƒÎ². Ï†Ï‰Î»Î¹Î¬: ÎŒÎ»ÎµÏ‚</option>
        <option value="ÎÎ±Î¹">ÎœÎµ Ï†Ï‰Î»Î¹Î¬</option>
        <option value="ÎŒÏ‡Î¹">Î§Ï‰ÏÎ¯Ï‚ Ï†Ï‰Î»Î¹Î¬</option>
      </select>

      <select id="f-muni" class="select-pill row2">
        <option value="">ÎŒÎ»Î¿Î¹ Î¿Î¹ Î´Î®Î¼Î¿Î¹</option>
      </select>

      <button id="btn-reset" class="pill pill-reset">â†º Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Ï†Î¯Î»Ï„ÏÏ‰Î½</button>

    </div>
  </div>
</div>


    <div class="card list-title">
      Î›Î¯ÏƒÏ„Î± ÎºÏÎ¿Ï…Î½ÏÎ½ (<span id="list-count">0</span>)
    </div>

    <div class="card" style="overflow:auto; max-height:100%;">
      <table id="table">
        <thead>
        <tr>
          <th data-sort="name">ÎŒÎ½Î¿Î¼Î±</th>
          <th data-sort="status">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
          <th data-sort="lastInspection">Î•Ï€Î¹Î¸.</th>
          <th data-sort="storts">Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ÏÏ„Ï‚</th>
          <th data-sort="comments">Î£Ï‡ÏŒÎ»Î¹Î±</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <p id="empty" class="muted" style="display:none; padding:8px;">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎºÏÎ¿Ï…Î½Î¿Î¯â€¦</p>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
  /* ---- helpers ---- */
  const normalize = (s) => (s||"").toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim();
  const esc = (s)=>String(s ?? "-").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  function statusClass(status){
    const s = normalize(status);
    if (s === "Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™ÎšÎŸÎ£") return "ok";
    if (s === "ÎœÎ• Î Î¡ÎŸÎ’Î›Î—ÎœÎ‘") return "faulty";
    if (s === "Î•ÎšÎ¤ÎŸÎ£ Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î‘Î£") return "unknown";
    return "unknown";
  }
  function formatDate(dateStr) {
    if (!dateStr) return "-";
    if (typeof dateStr === "string" && (/[?]/.test(dateStr) || /-00-00$/.test(dateStr))) return "-";
    const d = new Date(dateStr);
    if (isNaN(d)) return "-";
    const day = String(d.getDate()).padStart(2,"0");
    const month = String(d.getMonth()+1).padStart(2,"0");
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  }

  // Emoji icon
  const hydrantEmojiIcon = L.divIcon({
    className: "emoji-pin",
    html: "ğŸ§¯",
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -12]
  });

  /* ---- app state ---- */
  let state = { data:[], filtered:[], selectedId:null, sortBy:"name", sortDir:"asc", markersById:new Map() };

  /* ---- map ---- */
  const map = L.map('map', { doubleClickZoom: false, closePopupOnClick: false })
    .setView([37.9838,23.7275], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

  /* ---- ui ---- */
  const tbody=document.getElementById('tbody');
  const emptyEl=document.getElementById('empty');
  const searchInput=document.getElementById('search');
  const onlyOk=document.getElementById('f-only-ok');
  const onlyStorts=document.getElementById('f-only-storts');
  const btnReset=document.getElementById('btn-reset');
  const listCount=document.getElementById('list-count');
  const muniSelect=document.getElementById('f-muni');
  const cabinetSelect=document.getElementById('f-cabinet');

  /* ---- events ---- */
  onlyOk.addEventListener('change',()=>{ if(onlyOk.checked) onlyStorts.checked=false; applyAll(); });
  onlyStorts.addEventListener('change',()=>{ if(onlyStorts.checked) onlyOk.checked=false; applyAll(); });
  searchInput.addEventListener('input',()=>applyAll());
  muniSelect.addEventListener('change', applyAll);
  cabinetSelect.addEventListener('change', applyAll);

  btnReset.addEventListener('click',()=>{
    searchInput.value="";
    onlyOk.checked=false;
    onlyStorts.checked=false;
    muniSelect.value="";
    cabinetSelect.value="";
    applyAll();
  });

  document.querySelectorAll('th[data-sort]').forEach(th=>{
    th.addEventListener('click',()=>{
      const key=th.getAttribute('data-sort');
      if(state.sortBy===key){ state.sortDir=state.sortDir==="asc"?"desc":"asc"; }
      else { state.sortBy=key; state.sortDir="asc"; }
      applyAll();
    });
  });

  /* ---- renderers ---- */
  function renderTable(){
    tbody.innerHTML="";
    listCount.textContent = String(state.filtered.length);
    if(state.filtered.length===0){ emptyEl.style.display="block"; return; }
    emptyEl.style.display="none";
    for(const h of state.filtered){
      const tr=document.createElement('tr');
      if(h.id===state.selectedId) tr.classList.add('active');
      tr.onclick=()=>selectHydrant(h.id,{fly:true});
      const badge = `<span class="badge ${statusClass(h.status)}">${esc(h.status)}</span>`;
      tr.innerHTML = `
        <td>${esc(h.name)}</td>
        <td class="status-cell">${badge}</td>
        <td>${formatDate(h.lastInspection)}</td>
        <td>${esc(h.storts)}</td>
        <td class="note">${esc(h.comments)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderMarkers(){
    for (const [,m] of state.markersById) map.removeLayer(m);
    state.markersById.clear();
    for (const h of state.filtered){
      const marker = L.marker([h.lat, h.lng], { icon: hydrantEmojiIcon }).addTo(map);
      const html = `
        <b>${esc(h.name)}</b><br/>
        Î”Î®Î¼Î¿Ï‚: ${esc(h.municipality || "-")}<br/>
        ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·: ${esc(h.status)}<br/>
        Î•Ï€Î¹Î¸.: ${formatDate(h.lastInspection)}<br/>
        Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ÏÏ„Ï‚: ${esc(h.storts)}<br/>
        Î Ï…ÏÎ¿ÏƒÎ². Ï†Ï‰Î»Î¹Î¬: ${esc(h.cabinet || "-")}<br/>
        Î£Ï‡ÏŒÎ»Î¹Î±: ${esc(h.comments)}
      `;
      marker.bindPopup(html, { autoPan: true });
      marker.on('click', (e) => {
        if (e && e.originalEvent) { e.originalEvent.preventDefault(); e.originalEvent.stopPropagation(); }
        selectHydrant(h.id, { fly: false });
        marker.openPopup();
      });
      state.markersById.set(h.id, marker);
    }
  }

  function selectHydrant(id, opts = {}) {
    state.selectedId = id;
    for (const tr of tbody.querySelectorAll('tr')) tr.classList.remove('active');
    const idx = state.filtered.findIndex(x => x.id === id);
    if (idx >= 0 && tbody.children[idx]) tbody.children[idx].classList.add('active');
    const h = state.data.find(x => x.id === id);
    if (!h) return;
    if (opts.fly !== false) map.flyTo([h.lat, h.lng], 16);
    const m = state.markersById.get(id);
    if (m) m.openPopup();
  }

  function applyAll(){
    const q = normalize(searchInput.value || "");
    const selectedMuni = muniSelect.value || "";
    const selectedCab  = cabinetSelect.value || "";

    let f = state.data.filter(h=>{
      const text = normalize(`${h.name||""} ${h.status||""} ${h.storts||""} ${h.comments||""} ${h.municipality||""} ${h.cabinet||""}`);
      if(q && !text.includes(q)) return false;
      if (onlyOk.checked && !h.functional) return false;        // ÎœÏŒÎ½Î¿ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÎºÎ¿Î¯
      if (onlyStorts.checked && !h.needsStorts) return false;   // ÎœÏŒÎ½Î¿ ÏŒÏƒÎ¿Î¹ Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î¿ÏÏ„Ï‚
      if (selectedMuni && (h.municipality||"") !== selectedMuni) return false;
      if (selectedCab  && (h.cabinet||"")      !== selectedCab ) return false;
      return true;
    });

    const dir=state.sortDir==="asc"?1:-1;
    f.sort((a,b)=>{
      const k=state.sortBy;
      const va=(a[k]??"").toString().toLowerCase();
      const vb=(b[k]??"").toString().toLowerCase();
      if(va<vb) return -1*dir; if(va>vb) return 1*dir; return 0;
    });

    state.filtered=f; renderTable(); renderMarkers();
  }

  function init(data){
    state.data=data; applyAll();
    if(state.filtered[0]) selectHydrant(state.filtered[0].id,{fly:false});
  }

  // --- Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Excel -> ISO (yyyy-mm-dd), Î±Î³Î½Î¿ÎµÎ¯ Î¬ÎºÏ…ÏÎµÏ‚ Î¼Î¿ÏÏ†Î­Ï‚
  function excelDateToISO(v) {
    if (v == null || v === "" || v === "-") return null;
    if (typeof v === "number") {
      const epoch = new Date(Date.UTC(1899, 11, 30));
      return new Date(epoch.getTime() + v * 86400000).toISOString().slice(0,10);
    }
    let s = String(v).trim();
    if (/\?/.test(s)) return null;
    if (/^[12]\d{3}[-\/\.]00(?:[-\/\.]00)?$/.test(s)) return null;
    let m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})(?:\s+\d{1,2}:\d{2})?$/);
    if (m) {
      const dd = m[1].padStart(2,"0");
      const mm = m[2].padStart(2,"0");
      const yy = m[3].length===2 ? ("20"+m[3]) : m[3];
      if (mm === "00" || dd === "00") return null;
      return `${yy}-${mm}-${dd}`;
    }
    m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})(?:\s+\d{1,2}:\d{2})?$/);
    if (m) {
      const yy = m[1], mm = String(m[2]).padStart(2,"0"), dd = String(m[3]).padStart(2,"0");
      if (mm === "00" || dd === "00") return null;
      return `${yy}-${mm}-${dd}`;
    }
    const d = new Date(s);
    if (!isNaN(d)) return d.toISOString().slice(0,10);
    return null;
  }

  // --- ÎšÎ±Î½Î¿Î½Î¹ÎºÎ¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚
  function normYesNo(v){
    const s = normalize(v);
    if (s==="ÎÎ‘Î™"||s==="NAI"||s==="YES"||s==="Y") return "ÎÎ±Î¹";
    if (s==="ÎŸÎ§Î™"||s==="OXI"||s==="NO"||s==="N") return "ÎŒÏ‡Î¹";
    return v ?? "-";
  }
  function normStatus(v){
    const s = normalize(v);
    if (s.includes("Î•ÎšÎ¤ÎŸÎ£")) return "Î•ÎšÎ¤ÎŸÎ£ Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î‘Î£";
    if (s.includes("Î Î¡ÎŸÎ’Î›Î—ÎœÎ‘")) return "ÎœÎ• Î Î¡ÎŸÎ’Î›Î—ÎœÎ‘";
    if (s.includes("Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Îš")) return "Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™ÎšÎŸÎ£";
    return v ?? "Î†Î³Î½Ï‰ÏƒÏ„Î¿";
  }

  // --- Î”Î®Î¼Î¿Î¹ (46)
  const MUNICIPALITIES = [
    "Î Î±Ï€Î¬Î³Î¿Ï…","Î§Î¿Î»Î±ÏÎ³Î¿Ï","Î“Î­ÏÎ±ÎºÎ±","Î Î±Î»Î»Î®Î½Î·Ï‚","Î‘Î½Î¸Î¿ÏÏƒÎ±Ï‚","Î‘ÏÎ³Î¹Î¸Î­Î±Ï‚",
    "Î‘Î³Î¯Î±Ï‚ Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®Ï‚","Î–Ï‰Î³ÏÎ¬Ï†Î¿Ï…","ÎšÎ±Î¹ÏƒÎ±ÏÎ¹Î±Î½Î®Ï‚","Î‘Î³. Î£Ï„Î­Ï†Î±Î½Î¿Ï…","Î†Î½Î¿Î¹Î¾Î·Ï‚",
    "Î”Î¹ÏŒÎ½Ï…ÏƒÎ¿Ï…","Î”ÏÎ¿ÏƒÎ¹Î¬Ï‚","ÎšÏÏ…Î¿Î½ÎµÏÎ¹Î¿Ï…","Î¡Î¿Î´ÏŒÏ€Î¿Î»Î·Ï‚","Î£Ï„Î±Î¼Î¬Ï„Î±","ÎšÎ·Ï†Î¹ÏƒÎ¹Î¬Ï‚",
    "Î. Î•ÏÏ…Î¸ÏÎ±Î¯Î±Ï‚","Î•ÎºÎ¬Î»Î·Ï‚","Î§Î±Î»Î±Î½Î´ÏÎ¯Î¿Ï…","Î’ÏÏÏ‰Î½Î±","Î‘Î¸Î·Î½Î±Î¯Ï‰Î½","ÎÎ­Î¿Ï… Î¨Ï…Ï‡Î¹ÎºÎ¿Ï",
    "Î—Î»Î¹Î¿ÏÏ€Î¿Î»Î·Ï‚","Î“Î»Ï…Ï†Î¬Î´Î±Ï‚","Î¦Î¹Î»Î¿Î¸Î­Î·Ï‚","ÎœÎ±ÏÎºÏŒÏ€Î¿Ï…Î»Î¿Ï… ÎœÎµÏƒÎ¿Î³Î±Î¯Î±Ï‚","Î¡Î±Ï†Î®Î½Î±Ï‚",
    "ÎšÎ¿ÏÏ‰Ï€Î¯","Î Î±Î¹Î±Î½Î¯Î±Ï‚","Î£Ï€Î¬Ï„Ï‰Î½","Î§ÏÎ¹ÏƒÏ„Î¿ÏÏ€Î¿Î»Î·","Î‘Î¼Î±ÏÎ¿Ï…ÏƒÎ¯Î¿Ï…","Î’ÏÎ¹Î»Î®ÏƒÏƒÎ¹Ï‰Î½",
    "Î“Î±Î»Î±Ï„ÏƒÎ¯Î¿Ï…","Î‘ÏÏ„Î­Î¼Î¹Î´Î¿Ï‚","ÎšÎ±Î»Î»Î¹Ï„ÎµÏ‡Î½Î¿ÏÏ€Î¿Î»Î·","Î“Î»Ï…ÎºÏÎ½ ÎÎµÏÏÎ½","ÎšÎ±Î»ÏÎ²Î¹Ï‰Î½",
    "Î’Î¬ÏÎ·Ï‚","Î’Î¿Ï…Î»Î¹Î±Î³Î¼Î­Î½Î·Ï‚","ÎšÎ¯Ï„ÏƒÎ¹","Î†Î»Î¹Î¼Î¿Ï…","Î‘ÏÎ³Ï…ÏÎ¿ÏÏ€Î¿Î»Î·Ï‚","Î•Î»Î»Î·Î½Î¹ÎºÎ¿Ï","Î’Î¿ÏÎ»Î±Ï‚"
  ];
  const _MUNI_MAP = new Map(MUNICIPALITIES.map(n => [normalize(n).replace(/\s+/g,' '), n]));
  const MUNI_ALIASES = {
    "Î”Î—ÎœÎŸÎ£ Î‘Î˜Î—ÎÎ‘Î™Î©Î": "Î‘Î¸Î·Î½Î±Î¯Ï‰Î½",
    "ÎÎ•Î‘Î£ Î•Î¡Î¥Î˜Î¡Î‘Î™Î‘Î£": "Î. Î•ÏÏ…Î¸ÏÎ±Î¯Î±Ï‚",
    "Î Î•Î¡Î¥Î˜Î¡Î‘Î™Î‘Î£": "Î. Î•ÏÏ…Î¸ÏÎ±Î¯Î±Ï‚",
    "Î’Î¡Î™Î›Î—Î£Î£Î™Î©Î": "Î’ÏÎ¹Î»Î®ÏƒÏƒÎ¹Ï‰Î½",
    "ÎšÎ¡Î¥ÎŸÎÎ•Î¡Î™ÎŸÎ¥": "ÎšÏÏ…Î¿Î½ÎµÏÎ¹Î¿Ï…",
  };
  function canonMunicipality(v) {
    if (!v) return "";
    const raw = String(v).trim().replace(/^Î”(Î—|Î—ÎœÎŸÎ£|\.|Î—ÎœÎŸÎ¥)?\s*/i, ""); // Î±Ï†Î±Î¹ÏÎµÎ¯ "Î”Î—ÎœÎŸÎ£ "
    const key = normalize(raw).replace(/\s+/g, " ");
    if (MUNI_ALIASES[key]) return MUNI_ALIASES[key];
    return _MUNI_MAP.get(key) || String(v).trim();
  }

  function populateMuniFilter(data){
    muniSelect.innerHTML = "";
    muniSelect.appendChild(new Option("ÎŒÎ»Î¿Î¹ Î¿Î¹ Î´Î®Î¼Î¿Î¹",""));
    for(const m of MUNICIPALITIES) muniSelect.appendChild(new Option(m,m));
    const known = new Set(MUNICIPALITIES);
    const extra = new Set();
    for(const h of data){
      const m = (h.municipality||"").trim();
      if(m && !known.has(m)) extra.add(m);
    }
    for(const m of [...extra].sort()) muniSelect.appendChild(new Option(m,m));
  }

  // --- Î‘Î½Î¬Î³Î½Ï‰ÏƒÎ· Î³ÏÎ±Î¼Î¼ÏÎ½ & parsing
  function rowsToHydrants(rows){
    const out = [];
    let autoId = 1;

    for (const r0 of rows){
      // trim ÏƒÏ„Î± Î¿Î½ÏŒÎ¼Î±Ï„Î± ÎºÎµÏ†Î±Î»Î¯Î´Ï‰Î½ Î±Î½Î¬ Î³ÏÎ±Î¼Î¼Î® (Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î± Î±Ï€ÏŒ "ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î— ")
      const r = {};
      for (const k in r0) {
        const t = (typeof k === 'string') ? k.trim() : k;
        r[t] = r0[k];
      }

      const idRaw   = r["Î‘/Î‘"] ?? r["AA"] ?? r["A/A"] ?? r["ID"] ?? r["Id"] ?? null;
      const dimos   = r["Î”Î—ÎœÎŸÎ£"] ?? r["Î”Î—ÎœÎŸÎ£."] ?? r["DHMOS"] ?? r["Municipality"] ?? "";
      const name    = r["Î”Î™Î•Î¥Î˜Î¥ÎÎ£Î—"] ?? r["Î”Î™Î•Î¥Î˜Î¥ÎÎ£Î— "] ?? r["ÎŸÎ”ÎŸÎ£"] ?? r["Address"] ?? "";
      const lat     = r["LAT"] ?? r["Lat"] ?? r["lat"];
      const lng     = r["LNG"] ?? r["Lon"] ?? r["LNG/LON"] ?? r["lon"] ?? r["LONG"] ?? r["Long"];
      const status  = r["ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î—"] ?? r["ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·"] ?? r["Status"];
      const insp    = r["Î•Î Î™Î˜Î•Î©Î¡Î—Î£Î—"] ?? r["Î•Ï€Î¹Î¸ÎµÏÏÎ·ÏƒÎ·"] ?? r["Last update"] ?? r["Î—Îœ/ÎÎ™Î‘"] ?? r["Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î•Ï€Î¹Î¸ÎµÏÏÎ·ÏƒÎ·Ï‚"];
      const storts  = r["Î§Î¡Î•Î™Î‘Î–Î•Î¤Î‘Î™ STORTS"] ?? r["STORTS"] ?? r["Î£Î¤ÎŸÎ¡Î¤Î£"] ?? r["Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ÏÏ„Ï‚"];
      const comments= r["Î£Î§ÎŸÎ›Î™Î‘"] ?? r["Î£Ï‡ÏŒÎ»Î¹Î±"] ?? r["Comments"] ?? "-";
      const cabinet = r["Î Î¥Î¡ÎŸÎ£Î’Î•Î£Î¤Î™ÎšÎ— Î¦ÎŸÎ›Î™Î‘"] ?? r["Î Î¥Î¡ÎŸÎ£Î’Î•Î£Î¤Î™ÎšÎ— Î¦Î©Î›Î™Î‘"] ?? r["Î Ï…ÏÎ¿ÏƒÎ²ÎµÏƒÏ„Î¹ÎºÎ® Î¦Ï‰Î»Î¹Î¬"] ?? r["Î¦Î©Î›Î™Î‘"] ?? r["Î¦Î¿Î»Î¹Î¬"];

      if (!lat || !lng || !name) continue;

      const id = idRaw ? `H${String(idRaw).trim()}` : `H${autoId++}`;
      const statusClean = normStatus(status);
      const stortsClean = normYesNo(storts);
      const functional  = (normalize(statusClean) === "Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™ÎšÎŸÎ£");
      const needsStorts = (() => {
        const s = normalize(stortsClean);
        return (s === "ÎÎ‘Î™" || s === "NAI");
      })();

      out.push({
        id,
        name: String(name).trim(),
        lat: Number(String(lat).replace(",", ".")),
        lng: Number(String(lng).replace(",", ".")),
        status: statusClean,
        accessible: true,
        lastInspection: excelDateToISO(insp),
        comments: String(comments ?? "-").trim(),
        storts: stortsClean,
        functional,
        needsStorts,
        municipality: canonMunicipality(dimos),
        cabinet: normYesNo(cabinet)
      });
    }
    return out;
  }

  // --- Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Î½Î¯Ï‡Î½ÎµÏ…ÏƒÎ· Î³ÏÎ±Î¼Î¼Î®Ï‚ ÎµÏ€Î¹ÎºÎµÏ†Î±Î»Î¯Î´Ï‰Î½
  function sheetToMatrix(ws){
    return XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
  }
  function findHeaderRow(mat){
    const wanted = ["Î”Î™Î•Î¥Î˜Î¥ÎÎ£Î—","LAT","LNG"];
    for (let i = 0; i < mat.length; i++){
      const row = mat[i].map(x => String(x).trim());
      const hasAll = wanted.every(w => row.includes(w) || row.includes(w + " "));
      if (hasAll) return i;
    }
    for (let i = 0; i < mat.length; i++){
      if (mat[i].filter(x => String(x).trim() !== "").length >= 3) return i;
    }
    return 0;
  }

  // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Ï€ÏŒ Excel
  const fileInput = document.getElementById('file-xlsx');
  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type: 'array' });
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];

    const mat = sheetToMatrix(ws);
    const headerRow = findHeaderRow(mat);
    const rows = XLSX.utils.sheet_to_json(ws, { defval: "", range: headerRow });

    const parsed = rowsToHydrants(rows);
    if (!parsed.length) {
      console.warn("Header row guess:", headerRow, "First row:", mat[headerRow]);
      alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î­Î³ÎºÏ…ÏÎµÏ‚ Î³ÏÎ±Î¼Î¼Î­Ï‚ ÏƒÏ„Î¿ Excel.");
      return;
    }

    state.data = parsed;
    populateMuniFilter(parsed);
    applyAll();
    if (state.filtered[0]) selectHydrant(state.filtered[0].id, { fly: false });
  });

  // ÎÎµÎºÎ¯Î½Î± ÎºÎµÎ½ÏŒÏ‚
  init([]);
</script>
</body>
</html>
