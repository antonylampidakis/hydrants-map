<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <title>Î§Î¬ÏÏ„Î·Ï‚ ÎšÏÎ¿Ï…Î½ÏÎ½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header>
  <h1>Î§Î¬ÏÏ„Î·Ï‚ ÎºÏÎ¿Ï…Î½ÏÎ½</h1>
  <h3 style="color: red; text-align: left;">Î”Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î±Î½Î±Î²Î¬Î¸Î¼Î¹ÏƒÎ·Ï‚ ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·!!</h3>
  <input id="file-xlsx" type="file" accept=".xlsx" style="display:none;">
  <img src="newlogos.png" alt="Î›Î¿Î³ÏŒÏ„Ï…Ï€Î¿" class="logo" />
</header>

<div class="wrap">
  <div id="map" class="card"></div>

  <div class="panel">
    <input id="search" class="search card" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÎµ ÏŒÎ½Î¿Î¼Î±/ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·/ÏƒÏ„Î¿ÏÏ„Ï‚/Î´Î®Î¼Î¿/ÏƒÏ‡ÏŒÎ»Î¹Î±â€¦" />

    <div class="card filters">
      <div class="toolbar">
        <div class="toolbar-left">
          <label class="chip row1">
            <input type="checkbox" id="f-only-ok" />
            <span>ÎœÏŒÎ½Î¿ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÎºÎ¿Î¯</span>
          </label>
          <label class="chip row1">
            <input type="checkbox" id="f-only-storts" />
            <span>ÎœÏŒÎ½Î¿ ÏŒÏƒÎ¿Î¹ Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î¿ÏÏ„Ï‚</span>
          </label>
          <select id="f-muni" class="select-pill row2">
            <option value="">ÎŒÎ»Î¿Î¹ Î¿Î¹ Î´Î®Î¼Î¿Î¹</option>
          </select>
          <button id="btn-reset" class="pill pill-reset">â†º Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Ï†Î¯Î»Ï„ÏÏ‰Î½</button>
        </div>
      </div>
    </div>

    <div class="card list-title">
      Î›Î¯ÏƒÏ„Î± ÎºÏÎ¿Ï…Î½ÏÎ½ (<span id="list-count">0</span>)
    </div>

    <div id="list-card" class="card list-scroll">
      <table id="table">
        <thead>
          <tr>
            <th data-sort="name">ÎŒÎ½Î¿Î¼Î±</th>
            <th data-sort="status">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
            <th data-sort="lastInspection">Î•Ï€Î¹Î¸.</th>
            <th data-sort="storts">Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ÏÏ„Ï‚</th>
            <th data-sort="comments">Î£Ï‡ÏŒÎ»Î¹Î±</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <p id="empty" class="muted" style="display:none;padding:8px;">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎºÏÎ¿Ï…Î½Î¿Î¯â€¦</p>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
// ÎÎ•Î‘: Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î²Î¹Î²Î»Î¹Î¿Î¸Î·ÎºÏÎ½ Firebase (Î³Î¹Î± Î±Ï€Î»ÏŒ JS)
importScripts("https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js");
importScripts("https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js");
  
// ====== Î¡Î¥Î˜ÎœÎ™Î£Î— FIREBASE ======
// Î‘ÎÎ¤Î™ÎšÎ‘Î¤Î‘Î£Î¤Î—Î£Î¤Î• ÎœÎ• Î¤Î‘ Î”Î™ÎšÎ‘ Î£Î‘Î£ Î£Î¤ÎŸÎ™Î§Î•Î™Î‘ CONFIG
// ====== Î¡Î¥Î˜ÎœÎ™Î£Î— FIREBASE: Î Î¡Î‘Î“ÎœÎ‘Î¤Î™ÎšÎ•Î£ Î¤Î™ÎœÎ•Î£ ======
const firebaseConfig = {
    apiKey: "AIzaSyDG6M7ZNNxEVEwed6qKFG4S-Te-bmUQztk",
    authDomain: "hydrantsnearby.firebaseapp.com",
    projectId: "hydrantsnearby",
    storageBucket: "hydrantsnearby.appspot.com",
    messagingSenderId: "768296422349",
    appId: "1:768296422349:web:6516284f661cd8c16fd284", // <--- ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î¿ App ID
    // measurementId: "G-377W35XQ8Y" // Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ
};

// Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore(); // Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Ï„Î·Ï‚ Î²Î¬ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
  
  // === helpers ===
  const normalize = (s) => (s||"").toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim();
  const esc = (s)=>String(s ?? "-").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  function statusClass(status){
    const s = normalize(status);
    if (s === "Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™ÎšÎŸÎ£" || s==="ACTIVE") return "ok";
    if (s === "ÎœÎ• Î Î¡ÎŸÎ’Î›Î—ÎœÎ‘") return "faulty";
    if (s === "Î•ÎšÎ¤ÎŸÎ£ Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î‘Î£") return "unknown";
    return "unknown";
  }
  function formatDate(d){
    if (!d) return "-";
    const dd = new Date(d);
    if (isNaN(dd)) return "-";
    return `${dd.getDate().toString().padStart(2,"0")}/${(dd.getMonth()+1).toString().padStart(2,"0")}/${dd.getFullYear()}`;
  }

  // === map ===
  const hydrantIcon = L.divIcon({ className:"emoji-pin", html:"ğŸ§¯", iconSize:[24,24], iconAnchor:[12,12] });
  const map = L.map('map').setView([37.9838,23.7275], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

  // === state ===
  let state={data:[],filtered:[],selectedId:null,sortBy:"name",sortDir:"asc",markersById:new Map()};
  const tbody=document.getElementById('tbody');
  const emptyEl=document.getElementById('empty');
  const listCount=document.getElementById('list-count');
  const search=document.getElementById('search');
  const onlyOk=document.getElementById('f-only-ok');
  const onlyStorts=document.getElementById('f-only-storts');
  const muniSel=document.getElementById('f-muni');
  const btnReset=document.getElementById('btn-reset');

  // === filters ===
  onlyOk.onchange=()=>{if(onlyOk.checked) onlyStorts.checked=false; applyAll();};
  onlyStorts.onchange=()=>{if(onlyStorts.checked) onlyOk.checked=false; applyAll();};
  search.oninput=applyAll; muniSel.onchange=applyAll;
  btnReset.onclick=()=>{search.value="";onlyOk.checked=onlyStorts.checked=false;muniSel.value="";applyAll();};

  document.querySelectorAll('th[data-sort]').forEach(th=>{
    th.onclick=()=>{const k=th.dataset.sort;if(state.sortBy===k) state.sortDir=state.sortDir==="asc"?"desc":"asc";else{state.sortBy=k;state.sortDir="asc";}applyAll();};
  });

  function renderTable(){
    tbody.innerHTML=""; listCount.textContent=state.filtered.length;
    if(!state.filtered.length){ emptyEl.style.display="block"; return; }
    emptyEl.style.display="none";
    for(const h of state.filtered){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${esc(h.name)}</td>
        <td class="status-cell"><span class="badge ${statusClass(h.status)}">${esc(h.status)}</span></td>
        <td>${formatDate(h.lastInspection)}</td>
        <td>${esc(h.storts)}</td>
        <td>${esc(h.comments)}</td>`;
      tr.onclick=()=>selectHydrant(h.id,{fly:true});
      tbody.appendChild(tr);
    }
  }

  function hasValidCoords(h){
  return Number.isFinite(h.lat) && Number.isFinite(h.lng) &&
         Math.abs(h.lat) <= 90 && Math.abs(h.lng) <= 180;
}

  function renderMarkers(){
  // ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎ¼Î± Ï€Î±Î»Î¹ÏÎ½
  for (const [,m] of state.markersById) map.removeLayer(m);
  state.markersById.clear();

  // ÎÎ­Î± markers Î¼ÏŒÎ½Î¿ Î³Î¹Î± Ï„Î± Ï†Î¹Î»Ï„ÏÎ±ÏÎ¹ÏƒÎ¼Î­Î½Î± + bounds
  const bounds = L.latLngBounds();

  for (const h of state.filtered){
    if (!hasValidCoords(h)) continue;   // skip ÎºÎ±ÎºÎ¬ rows

    const m = L.marker([h.lat, h.lng], {icon: hydrantIcon}).addTo(map);
    m.bindPopup(
      `<b>${esc(h.name)}</b><br/>Î”Î®Î¼Î¿Ï‚: ${esc(h.municipality)}<br/>` +
      `ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·: ${esc(h.status)}<br/>Î•Ï€Î¹Î¸.: ${formatDate(h.lastInspection)}<br/>` +
      `Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ÏÏ„Ï‚: ${esc(h.storts)}<br/>Î£Ï‡ÏŒÎ»Î¹Î±: ${esc(h.comments)}`
    );
    m.on('click', ()=>selectHydrant(h.id,{fly:false}));
    state.markersById.set(h.id, m);
    bounds.extend([h.lat, h.lng]);
  }

  // Auto-zoom ÏƒÏ„Î± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± Ï„Î¿Ï… Ï†Î¯Î»Ï„ÏÎ¿Ï…
  if (bounds.isValid()) {
    map.fitBounds(bounds, { padding: [24,24], maxZoom: 16 });
  }
}

  function selectHydrant(id,{fly=true}={}){
    state.selectedId=id; const h=state.data.find(x=>x.id===id); if(!h) return;
    if(fly) map.flyTo([h.lat,h.lng],16); const m=state.markersById.get(id); if(m) m.openPopup();
  }

  // === Î”Î—ÎœÎŸÎ™: Î³Î­Î¼Î¹ÏƒÎ¼Î± ÎµÏ€Î¹Î»Î¿Î³ÏÎ½ ===
  function buildMunicipalityOptions(items){
    const set = new Set(
      items
        .map(h => (h.municipality ?? "").toString().trim())
        .filter(s => s.length)
    );
    const list = [...set].sort((a,b)=> a.localeCompare(b,'el',{sensitivity:'base'}));
    muniSel.innerHTML = "";
    muniSel.appendChild(new Option("ÎŒÎ»Î¿Î¹ Î¿Î¹ Î´Î®Î¼Î¿Î¹",""));
    for(const m of list){
      muniSel.appendChild(new Option(m, m));
    }
  }

  function applyAll(){
    const q=normalize(search.value);
    const selM=(muniSel.value||"").trim();
    let f=state.data.filter(h=>{
      const txt=normalize(`${h.name} ${h.status} ${h.storts} ${h.comments} ${h.municipality}`);
      if(q && !txt.includes(q)) return false;
      if(onlyOk.checked && !h.functional) return false;
      if(onlyStorts.checked && !h.needsStorts) return false;
      if(selM && normalize(h.municipality) !== normalize(selM)) return false; // normalized ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·
      return true;
    });
    f.sort((a,b)=>{
      const va=(a[state.sortBy]??"").toString().toLowerCase();
      const vb=(b[state.sortBy]??"").toString().toLowerCase();
      return va<vb?-1*(state.sortDir==="asc"?1:-1):va>vb?1*(state.sortDir==="asc"?1:-1):0;
    });
    state.filtered=f; renderTable(); renderMarkers();
  }

  // === fetch ===
  async function fetchHydrants(){
 let data = [];
    let error = null;

    try {
        // ÎÎ•Î‘: ÎšÎ»Î®ÏƒÎ· ÏƒÏ„Î¿ Firebase Firestore
        const snapshot = await db.collection('hydrants').limit(5000).get();
        
        // ÎœÎµÏ„Î±Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ Ï„Î± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± Ï„Î¿Ï… Firestore ÏƒÎµ Ï€Î¯Î½Î±ÎºÎ±
        data = snapshot.docs.map(doc => ({
            id: doc.id, 
            ...doc.data() 
        }));

    } catch (e) {
        error = e;
        console.error("Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬ÎºÏ„Î·ÏƒÎ·Ï‚ Î±Ï€ÏŒ Firebase Firestore:", e);
        // Î”ÎµÎ½ ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†Î¿Ï…Î¼Îµ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Î½ Ï…Ï€Î¬ÏÎ¾ÎµÎ¹ ÏƒÏ†Î¬Î»Î¼Î±
        return; 
    }
    // ... ÎŸ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Ï‚ ÎºÏÎ´Î¹ÎºÎ±Ï‚ mapping ÏƒÏ…Î½ÎµÏ‡Î¯Î¶ÎµÎ¹ ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬ ...
    const mapped=(data||[]).map(h=>({
      id:h.id,
      name:h.name||h.code||"ÎšÏÎ¿Ï…Î½ÏŒÏ‚",
      status:h.status||"",
      municipality:h.municipality||"",
      lastInspection:h.last_verified_at||null,
      // Î±Î½ ÏƒÏ„Î¿ DB Ï„Î¿ needsStorts=true ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ "Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹", Î¬Î»Î»Î±Î¾Îµ Ï„Î¹Ï‚ 2 Î³ÏÎ±Î¼Î¼Î­Ï‚ ÏŒÏ€Ï‰Ï‚ Î¸ÎµÏ‚
      storts:(h.needsStorts===false)?"ÎÎ±Î¹":"ÎŒÏ‡Î¹",
      comments:h.comments||"",
      functional:normalize(h.status)==="Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™ÎšÎŸÎ£"||normalize(h.status)==="ACTIVE",
      needsStorts:(h.needsStorts===false),
     lat: (h.lat == null ? NaN : Number(h.lat)),
     lng: (h.lon == null ? NaN : Number(h.lon))
    }));

    state.data=mapped;
    buildMunicipalityOptions(state.data);    // <-- Î³Î­Î¼Î¹ÏƒÎ¼Î± dropdown
    applyAll();
    if(state.filtered[0]) selectHydrant(state.filtered[0].id,{fly:false});
  }

  fetchHydrants();
</script>
</body>
</html>



